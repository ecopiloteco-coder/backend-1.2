# EcoPilot ‚Äî Event System Reference (MongoDB)

## Collection: `events`

Each document in the `events` collection follows this schema:

```ts
{
  _id:           ObjectId,   // Auto-generated by MongoDB
  action:        string,     // Event type identifier (see below)
  metadata:      object,     // Action-specific payload
  userId:        number,     // PostgreSQL user ID (integer)
  entityId:      string,     // ID of the primary entity (projet, lot, ouvrage, bloc, article)
  serviceSource: string,     // Backend service that emitted the event
  timestamp:     Date,       // Auto-set; documents expire after 90 days (TTL index)
}
```

---

## Event Catalogue

### üìÅ Projet ‚Äî `serviceSource: "project"`

| `action` | `entityId` | `metadata` |
|---|---|---|
| `projet_ajouter` | `projet._id` | `{ projet: number, nom_projet: string }` |

---

### üì¶ Lot ‚Äî `serviceSource: "project"`

| `action` | `entityId` | `metadata` |
|---|---|---|
| `CREATE_LOT` | `lot._id` | `{ projet: number, lot: number, designation: string }` |
| `UPDATE_LOT` | `lot._id` | `{ projet: number, lot: number, designation_old: string, designation_new: string }` |
| `DELETE_LOT` | `lot._id` | `{ projet: number, lot: number, designation: string }` |

---

### üèóÔ∏è Ouvrage ‚Äî `serviceSource: "project"`

| `action` | `entityId` | `metadata` |
|---|---|---|
| `ouvrage_ajouter` | `ouvrage._id` | `{ projet: number, lot: number, ouvrage: number, nom_ouvrage: string, designation: string, hasBloc: boolean }` |
| `ouvrage_modifier` | `ouvrage._id` | `{ projet: number, lot: number, ouvrage: number, nom_ouvrage?: {old, new}, designation?: {old, new} }` |
| `ouvrage_supprimer` | `ouvrage._id` | `{ projet: number, lot: number, ouvrage: number, nom_ouvrage: string, designation: string }` |
| `ouvrage_dupliquer` | `newOuvrage._id` | `{ projet: number, lot: number, ouvrage: number, "nouveau ouvrage": string, designation: string, "ouvrage dupliqu√©": string }` |

---

### üß± Bloc ‚Äî `serviceSource: "project"`

| `action` | `entityId` | `metadata` |
|---|---|---|
| `bloc_created` | `bloc._id` | `{ projet: number, lot: number, ouvrage: number, bloc: number, nom_bloc: string, designation: string }` |
| `bloc_modifier` | `bloc._id` | `{ projet: number, lot: number, ouvrage: number, bloc: number, nom_bloc?: {old, new}, designation?: {old, new}, unite?: {old, new}, quantite?: {old, new} }` |
| `bloc_supprimer` | `bloc._id` | `{ projet: number, lot: number, ouvrage: number, bloc: number, nom_bloc: string, designation: string }` |

---

### üìÑ Article ‚Äî `serviceSource: "project"`

| `action` | `entityId` | `metadata` |
|---|---|---|
| `projet_article_ajouter` | `projetArticle._id` | `{ projet: number, lot?: number, ouvrage?: number, bloc?: number, article: number, designation: string, quantite: number, nouv_prix: number }` |
| `projet_article_modifier` | `projetArticle._id` | `{ projet: number, lot?: number, ouvrage?: number, bloc?: number, article: number, nouv_prix?: {old, new}, quantite?: {old, new}, tva?: {old, new}, designation_article?: {old, new} }` |
| `projet_article_supprimer` | `projetArticle._id` | `{ projet: number, lot?: number, ouvrage?: number, bloc?: number, article: number, designation: string, quantite: number }` |

---

### üì• Import DPGF ‚Äî `serviceSource: "importService"`

| `action` | `entityId` | `metadata` |
|---|---|---|
| `DPGF_IMPORT` | `projet._id` | `{ projet: number, processedCount: number, createdLotIds: string[], source: "DPGF", lots: [{ lotId, lotLabel, fileName }] }` |

---

## Example Documents

### `projet_ajouter`
```json
{
  "_id": "65f1a2b3c4d5e6f7a8b9c0d1",
  "action": "projet_ajouter",
  "userId": 42,
  "entityId": "7",
  "serviceSource": "projetService",
  "timestamp": "2026-02-19T11:00:00.000Z",
  "metadata": {
    "nom_projet": "R√©novation Bureaux Lyon"
  }
}
```

### `projet_article_modifier`
```json
{
  "_id": "65f1a2b3c4d5e6f7a8b9c0d2",
  "action": "projet_article_modifier",
  "userId": 42,
  "entityId": "18",
  "serviceSource": "articleService",
  "timestamp": "2026-02-19T11:05:30.000Z",
  "metadata": {
    "nouv_prix": { "old": 120.00, "new": 135.50 },
    "quantite": { "old": 10, "new": 12 }
  }
}
```

### `DPGF_IMPORT`
```json
{
  "_id": "65f1a2b3c4d5e6f7a8b9c0d3",
  "action": "DPGF_IMPORT",
  "userId": 42,
  "entityId": "7",
  "serviceSource": "importService",
  "timestamp": "2026-02-19T11:10:00.000Z",
  "metadata": {
    "processedCount": 48,
    "createdLotIds": ["10", "11"],
    "source": "DPGF",
    "lots": [
      { "lotId": "10", "lotLabel": "Gros ≈íuvre", "fileName": "dpgf_2026.xlsx" }
    ]
  }
}
```

---

## Mongoose Schema (actual model)

```js
const mongoose = require('mongoose');

const EventSchema = new mongoose.Schema({
    action: {
        type: String,
        required: true
    },
    metadata: {
        type: Object
    },
    userId: {
        type: Number // Matches PostgreSQL ID type
    },
    entityId: {
        type: String
    },
    serviceSource: {
        type: String
    },
    timestamp: {
        type: Date,
        default: Date.now,
        index: { expires: '90d' } // TTL Index: Auto delete after 90 days
    }
});

module.exports = mongoose.model('Event', EventSchema);
```
