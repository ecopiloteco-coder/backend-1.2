name: Monitoring CI

on:
  push:
    branches: [ Devops2 ]
    paths:
      - 'infrastructure/monitoring/**'
      - '.github/workflows/monitoring-ci.yml'
  pull_request:
    branches: [ Devops2 ]
    paths:
      - 'infrastructure/monitoring/**'
  workflow_dispatch:

jobs:
  # ================ VALIDATION ===================
  validate:
    name: Validate Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Check YAML syntax for all monitoring files
      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: infrastructure/monitoring/
          config_data: "{extends: default, rules: {line-length: disable}}"

      # 2. Specific Prometheus config validation using promtool
      - name: Prometheus Config Check
        run: |
          docker run --rm \
            --entrypoint promtool \
            -v ${{ github.workspace }}/infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            prom/prometheus:latest check config /etc/prometheus/prometheus.yml

  # ================ SECURITY ===================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Gitleaks scan for secrets in monitoring configs
      - name: Gitleaks Scan
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.2_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks detect --source=infrastructure/monitoring --verbose --redact --exit-code=0

      # 2. Trivy scan for official images used in monitoring
      - name: Scan Official Prometheus Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'prom/prometheus:latest'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Scan Official Grafana Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'grafana/grafana:latest'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
